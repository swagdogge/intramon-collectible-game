<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Intramon</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(180deg, #ffffff, #ffffff52);
      margin: 0; padding: 20px; text-align: center;
    }
    h1 { color: #5f5f5f; text-shadow: 1px 1px 3px rgba(0,0,0,0.2); }
    #top-bar {
      display: flex; justify-content: space-between; align-items: center;
      background: rgba(255,255,255,0.8);
      padding: 10px 20px; border-radius: 12px; margin-bottom: 20px;
      max-width: 800px; margin-left:auto; margin-right:auto;
    }
	
    #monster-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 20px; padding: 20px; max-width: 800px; margin: 0 auto;
    }
    .monster-card {
      background: rgba(255,255,255,0.9); border-radius: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      padding: 15px; cursor: pointer; border: 3px solid transparent;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .monster-card:hover {
      transform: scale(1.05); box-shadow: 0 6px 15px rgba(0,0,0,0.3);
    }
    .monster-card img { width: 100px; height: 100px; object-fit: contain; margin-bottom: 10px; }
    button {
      margin-top: 10px; padding: 10px 20px; font-size: 14px;
      border: none; background-color: #802200; color: white; border-radius: 8px;
      cursor: pointer; transition: background 0.2s;
    }
    button:hover { background-color: #e03e00; }
    /* Modals */
    .modal { display:none; position: fixed; top:0; left:0; width:100%; height:100%;
      background: rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:999; }
    .modal.show { display:flex; }
    .modal-content {
      background: white; border-radius:15px; padding:25px; width:320px;
      text-align:center; position: relative; box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    }
    .modal-content img { width:150px; height:150px; object-fit:contain; margin-bottom:15px; }
    .close-btn { position:absolute; top:10px; right:15px; font-size:22px; cursor:pointer; }
    .stats p { margin:5px 0; }
  </style>
</head>
<body>
<h1>Intramon</h1>

<div id="top-bar" style="display:none;">
  <span id="username-display"></span>
  <button id="check-inbox-btn">Check Inbox</button>
  <input id="claim-code-input" placeholder="Enter claim code" style="padding:8px;border-radius:8px;border:1px solid #ccc;">
<button id="claim-code-btn">Redeem</button>
	<div id="sort-controls" style="display: flex; align-items: center; gap: 10px;">
  <label for="sort-select">Sort by:</label>
  <select id="sort-select">
    <option value="name">Name</option>
    <option value="rarity">Rarity</option>
    <option value="element">Element</option>
  </select>
  <button id="sort-order-btn" title="Toggle order">⬆️</button>
</div>

</div>
<div id="main-container" style="display: flex; max-width: 1000px; margin: 0 auto; gap: 20px;">
  <!-- Leaderboard -->
  <div id="leaderboard" style="width: 200px; background: rgba(255,255,255,0.9); border-radius:12px; padding:15px; box-shadow: 0 4px 10px rgba(0,0,0,0.2);">
    <h3>Leaderboard</h3>
    <ol id="leaderboard-list" style="padding-left:20px; margin:0;"></ol>
	<button id="leaderboard-refresh-btn" style="margin-top:10px; padding:5px 10px; font-size:12px; cursor:pointer;">Refresh</button>
  </div>


<div id="monster-grid"></div>
<button id="login-btn">Login via 42</button>

<!-- Monster Modal -->
<div id="monster-modal" class="modal">
  <div class="modal-content">
    <span class="close-btn">&times;</span>
    <img id="modal-img" src="" alt="Monster">
    <h2 id="modal-name"></h2>
    <small id="modal-rarity"></small>
    <div class="stats">
      <p><b>HP:</b> <span id="modal-hp"></span></p>
      <p><b>Attack:</b> <span id="modal-attack"></span></p>
      <p><b>Defense:</b> <span id="modal-defense"></span></p>
    </div>
    <button id="gift-btn">Gift to Player</button>
  </div>
</div>

<!-- Inbox Modal -->
<div id="inbox-modal" class="modal">
  <div class="modal-content">
    <span class="close-btn">&times;</span>
    <h3 id="inbox-reason"></h3>
    <img id="inbox-img" src="" alt="Inbox Monster">
    <h2 id="inbox-name"></h2>
    <small id="inbox-rarity"></small>
    <button id="claim-btn">Claim Monster</button>
	<button id="claim-all-btn">Claim All</button>
<span id="inbox-count"></span>

  </div>
</div>

<script>
const getRarityColor = (rarity) => {
  switch (rarity?.toLowerCase()) {
    case 'common': return '#4CAF50';
    case 'rare': return '#2196F3';
    case 'epic': return '#9C27B0';
    case 'legendary': return '#FF9800';
    default: return '#555';
  }
};

const elementColors = {
  Electro: '#FFD700',
  Water: '#00BFFF',
  Fire: '#FF4500',
  Ice: '#00FFFF',
  Plant: '#32CD32',
  Ground: '#8B4513'
};

let allMonsters = [];
let currentSort = { key: 'name', ascending: true };

// --- Monster Modal ---
const monsterModal = document.getElementById('monster-modal');
function openMonsterModal(monster) {
  document.getElementById('modal-img').src = monster.image || '/monsters/placeholder.png';
  document.getElementById('modal-name').textContent = monster.name;
  document.getElementById('modal-rarity').textContent = monster.rarity.toUpperCase();
  document.getElementById('modal-rarity').style.color = getRarityColor(monster.rarity);
  document.getElementById('modal-hp').textContent = monster.hp;
  document.getElementById('modal-attack').textContent = monster.attack;
  document.getElementById('modal-defense').textContent = monster.defense;
  monsterModal.classList.add('show');
  document.getElementById('gift-btn').onclick = () => giftMonster(monster);
}
function closeMonsterModal() { monsterModal.classList.remove('show'); }
document.querySelector('#monster-modal .close-btn').addEventListener('click', closeMonsterModal);
monsterModal.addEventListener('click', e => { if (e.target === monsterModal) closeMonsterModal(); });

// --- Render Monsters ---
function renderMonsters(monsters) {
  const gridEl = document.getElementById('monster-grid');
  gridEl.innerHTML = '';

  // Sort
  const sorted = [...monsters].sort((a, b) => {
    const dir = currentSort.ascending ? 1 : -1;
    if (currentSort.key === 'rarity') {
      const order = ['common', 'rare', 'epic', 'legendary'];
      return (order.indexOf(a.rarity.toLowerCase()) - order.indexOf(b.rarity.toLowerCase())) * dir;
    }
    if (currentSort.key === 'element') {
      if (a.element === b.element)
        return a.name.localeCompare(b.name) * dir;
      return a.element.localeCompare(b.element) * dir;
    }
    // Default: name
    return a.name.localeCompare(b.name) * dir;
  });

  sorted.forEach(m => {
    const card = document.createElement('div');
    card.className = 'monster-card';
    card.style.borderColor = getRarityColor(m.rarity);
    card.innerHTML = `
      <img src="${m.image || '/monsters/placeholder.png'}" 
           alt="${m.name}" 
           onerror="this.onerror=null;this.src='/monsters/placeholder.png';">
      <h3 style="color:${elementColors[m.element] || '#555'}">${m.name}</h3>
      <small>${m.rarity.toUpperCase()}</small>
    `;
    card.addEventListener('click', () => openMonsterModal(m));
    gridEl.appendChild(card);
  });
}

// --- Fetch Monsters ---
async function fetchMonsters() {
  try {
    const res = await fetch('/my-monsters');
    if (!res.ok) return;
    const data = await res.json();
    allMonsters = data.monsters || [];
    document.getElementById('username-display').textContent = `Logged in as: ${data.name}`;
    renderMonsters(allMonsters);
  } catch (err) {
    console.error('Failed to fetch mons:', err);
  }
}


// --- Gift Monster ---
async function giftMonster(monster) {
  const toUsername = prompt('Enter receiver username:');
  if (!toUsername) return;
  try {
    const userRes = await fetch(`/find-user/${toUsername}`);
    const userData = await userRes.json();
    if (!userData.exists) { alert('User not found'); return; }
    const res = await fetch('/gift', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ toPlayerId: userData.playerId, offeredMonsters: [monster] })
    });
    const result = await res.json();
    if (res.ok) { alert('Monster sent to inbox!'); closeMonsterModal(); fetchMonsters(); }
    else { alert('Failed to gift: ' + (result.error || 'Unknown error')); }
  } catch (err) { console.error(err); alert('Gift failed: ' + err.message); }
}

async function fetchLeaderboard() {
  try {
    const res = await fetch('/leaderboard');
    if (!res.ok) throw new Error('Failed to fetch leaderboard');
    const data = await res.json();
    const listEl = document.getElementById('leaderboard-list');
    listEl.innerHTML = '';

    data.leaderboard.forEach(player => {
      const li = document.createElement('li');
      li.textContent = `${player.name} (${player.monsterCount})`;
      listEl.appendChild(li);
    });
  } catch (err) {
    console.error(err);
  }
}

// Refresh leaderboard every 30 seconds


// --- Inbox ---
const inboxModal = document.getElementById('inbox-modal');
const inboxReason = document.getElementById('inbox-reason');
const inboxImg = document.getElementById('inbox-img');
const inboxName = document.getElementById('inbox-name');
const inboxRarity = document.getElementById('inbox-rarity');
const claimBtn = document.getElementById('claim-btn');

let inboxQueue = [], currentInboxIndex = 0;

async function checkInbox() {
  try {
    const res = await fetch('/my-inbox');
    if (!res.ok) throw new Error('Failed to fetch inbox');
    const data = await res.json();
    
    if (!data.inbox.length) {
      alert('Inbox is empty :c'); 
      document.getElementById('inbox-count').textContent = '';
      return; 
    }

    inboxQueue = data.inbox;
    currentInboxIndex = 0;
    document.getElementById('inbox-count').textContent = `Inbox: ${data.count} monsters`;
    showInbox(currentInboxIndex);
  } catch (err) {
    console.error(err);
    alert(err.message);
  }
}

document.getElementById('check-inbox-btn').addEventListener('click', checkInbox);


document.getElementById('claim-all-btn').addEventListener('click', async () => {
  try {
    const res = await fetch('/claim-all', { method: 'POST' });
    const data = await res.json();
    if (res.ok) {
      alert(data.message);

      // Clear inbox and hide modal
      inboxQueue = [];
      currentInboxIndex = 0;
      inboxModal.classList.remove('show');

      // Update inbox count
      updateInboxCount();

      // Refresh monsters
      fetchMonsters();
    } else {
      alert(data.error || 'Failed to claim all');
    }
  } catch (err) {
    console.error(err);
    alert('Error claiming all monsters');
  }
});


function updateInboxCount() {
  const count = inboxQueue.length - currentInboxIndex;
  document.getElementById('inbox-count').textContent = `Inbox: ${count} monster${count !== 1 ? 's' : ''}`;
}

function showInbox(index) {
  if (index >= inboxQueue.length) {
    inboxModal.classList.remove('show');
    inboxQueue = [];
    currentInboxIndex = 0;
    updateInboxCount();
    fetchMonsters();
    return;
  }
  const mon = inboxQueue[index];
  inboxReason.textContent = `Reason: ${mon.reason.charAt(0).toUpperCase() + mon.reason.slice(1)}`;
  inboxName.textContent = mon.name;
  inboxRarity.textContent = mon.rarity.toUpperCase();
  inboxRarity.style.color = getRarityColor(mon.rarity);
  inboxImg.src = mon.image || '/monsters/placeholder.png';
  inboxModal.classList.add('show');

  updateInboxCount(); // Update count every time a monster is shown

  claimBtn.onclick = async () => {
    await claimMonster(mon.instanceId);
  };
}

async function claimMonster(instanceId) {
  try {
    const res = await fetch(`/claim/${instanceId}`, { method: 'POST' });
    if (!res.ok) throw new Error('Claim failed');

    currentInboxIndex++;
    showInbox(currentInboxIndex); // will also update count
  } catch (err) {
    console.error(err);
    alert(err.message);
  }
}


// --- Sort Controls ---
const sortSelect = document.getElementById('sort-select');
const sortOrderBtn = document.getElementById('sort-order-btn');

sortSelect.addEventListener('change', () => {
  currentSort.key = sortSelect.value;
  renderMonsters(allMonsters);
});

sortOrderBtn.addEventListener('click', () => {
  currentSort.ascending = !currentSort.ascending;
  sortOrderBtn.textContent = currentSort.ascending ? '⬆️' : '⬇️';
  renderMonsters(allMonsters);
});

//code handler

document.getElementById('claim-code-btn').addEventListener('click', async () => {
  const code = document.getElementById('claim-code-input').value.trim();
  if (!code) return alert('Enter a code!');
  try {
    const res = await fetch('/claim-code', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ code })
    });
    const data = await res.json();
    if (res.ok) {
      alert(`You received ${data.monster.name}! Check your inbox!`);
      document.getElementById('claim-code-input').value = '';
    } else {
      alert(data.error || 'Invalid code');
    }
  } catch (err) {
    console.error(err);
    alert('Error redeeming code');
  }
});
//refresh leaderboard
document.getElementById('leaderboard-refresh-btn').addEventListener('click', () => {
  fetchLeaderboard();
});

// --- Login / Init ---
// --- Login / Init ---
document.getElementById('login-btn').addEventListener('click', () => window.location.href = '/login');

(async function init() {
  try {
    const res = await fetch('/my-monsters');
    if (res.ok) {
      document.getElementById('login-btn').style.display = 'none';
      document.getElementById('top-bar').style.display = 'flex';
      await fetchMonsters();

      // ✅ Automatically refresh logtime upon page load
      console.log('Refreshing logtime...');
      try {
        const logRes = await fetch('/refresh-logtime');
        if (logRes.ok) {
          const logData = await logRes.json();
          console.log('Logtime refreshed:', logData);
          // You can optionally reward the player or display a popup here
          if (logData.rewardGranted) {
            alert(`You earned a reward for logging ${logData.hours} hours today!`);
            await checkInbox(); // auto-check inbox if they got something
          }
        } else {
          console.warn('Failed to refresh logtime');
        }
      } catch (err) {
        console.error('Error refreshing logtime:', err);
      }

      // Fetch leaderboard as well
      await fetchLeaderboard();
    }
  } catch (err) { 
    console.log('Not logged in'); 
  }
})();

</script>

</body>
</html>
